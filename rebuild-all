#!/bin/bash

hacking_dir=$(readlink -fn $(dirname "$BASH_SOURCE"))

for i in $(ANSIBLE_STDOUT_CALLBACK=json ansible localhost --playbook-dir $hacking_dir/ansible -m debug -a 'msg={{ aws_region_layout[aws_status][aws_region] | list }}' | jq -r '.plays[0].tasks[0].hosts.localhost.msg[]' | tr '-' '_'); do
    [[ $i = 'bastion' ]] && continue
    [[ $i = 'syslog' ]] && continue
    [[ $i = 'builder' ]] && continue
    [[ $i = 'dev' ]] && continue
    [[ $i = 'mx_test' ]] && continue
    $hacking_dir/build-ami $i &
    sleep 1m
done

wait

# Fix the terminal
reset
