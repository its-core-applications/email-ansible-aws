---

- hosts: localhost
  gather_facts: false
  become: false
  tasks:
    - name: Find excess AMIs
      ec2_ami_find:
        region: "{{ aws_region }}"
        owner: self
        ami_tags:
          os: rhel
          image_type: "{{ item }}"
        sort: name
        sort_order: descending
        sort_start: "{{ (item == 'junk') | ternary(0, 5) }}"
      register: result
      loop:
        - base
        - mx
        - egress
        - rbl
        - junk

    - name: Delete excess AMIs and their snapshots
      ec2_ami:
        region: "{{ aws_region }}"
        image_id: "{{ item }}"
        state: absent
        delete_snapshot: true
      loop: "{{ query('flattened', result | json_query('results[*].results[*].ami_id')) }}"
