- hosts: Class_egress
  serial: 1
  gather_facts: false
  tasks:
    - import_role:
        name: ec2_mark_oldest

- hosts: localhost
  become: false
  tasks:
    - import_role:
        name: route53_dns_from_inventory
      vars:
        dns_host: egress
        dns_group: Class_egress

    - import_role:
        name: route53_dns_from_inventory
      vars:
        dns_host: pink-jackdaw
        dns_group: Class_egress
        dns_private_ip: false

- hosts: Class_egress:&Status_spindown
  tasks:
    - when: region == aws_region
      block:
        - name: Stop sensu
          systemd:
            name: sensu-client
            state: stopped
          ignore_errors: true

        - import_role:
            name: redis_spindown

        - import_role:
            name: simta_spindown

        - import_role:
            name: ec2_eip_disassociate

        - name: Set status to spundown
          delegate_to: localhost
          become: false
          ec2_tag:
            region: "{{ region }}"
            profile: "{{ aws_profile_ec2 }}"
            resource: "{{ instance_id }}"
            tags:
              Status: spundown
