- hosts: Class_covid_relay:&Status_production
  tasks:
    - when: region == aws_region
      block:
        - name: Set status to spindown
          delegate_to: localhost
          become: false
          ec2_tag:
            region: "{{ region }}"
            profile: "{{ aws_profile_ec2 }}"
            resource: "{{ instance_id }}"
            tags:
              Status: spindown

        - meta: refresh_inventory

- import_playbook: setup_lb_covid_relay.yml

- hosts: Class_covid_relay:&Status_spindown
  tasks:
    - when: region == aws_region
      block:
        - import_role:
            name: sensu_spindown

        - import_role:
            name: simta_spindown

        - import_role:
            name: ec2_eip_disassociate

        - name: Set status to spundown
          delegate_to: localhost
          become: false
          ec2_tag:
            region: "{{ region }}"
            profile: "{{ aws_profile_ec2 }}"
            resource: "{{ instance_id }}"
            tags:
              Status: spundown
