From 7c5b7c1f9f24a4e18cdc8b2252a76cfbb3fa6662 Mon Sep 17 00:00:00 2001
From: EC2 Default User <ec2-user@jocular-rab.builder.a.mail.umich.edu>
Date: Mon, 18 Jun 2018 22:55:09 -0400
Subject: [PATCH] Use system jemalloc

---
 src/Makefile | 15 ++++-----------
 src/alloc.c  |  8 ++++----
 2 files changed, 8 insertions(+), 15 deletions(-)

diff --git a/src/Makefile b/src/Makefile
index 41a39b5..9cefef1 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -2,21 +2,17 @@ NAME=corvus
 CC=gcc
 PROFILE?=
 OPTIMIZATION?=-O2
-CFLAGS=-std=c99 -Wall $(OPTIMIZATION) $(PROFILE) -g -ggdb -D_GNU_SOURCE -I../deps/jemalloc/include
-LDFLAGS=-pthread -rdynamic $(PROFILE)
+CFLAGS=-std=c99 -Wall $(OPTIMIZATION) $(PROFILE) -g -ggdb -D_GNU_SOURCE
+LDFLAGS=-pthread -rdynamic $(PROFILE) -ljemalloc
 
-JEMALLOC=../deps/jemalloc/lib/libjemalloc.a
 BIN:=$(NAME)
 SRC:=$(wildcard *.c)
 OBJ:=$(SRC:%.c=%.o)
 
-%.o: %.c $(JEMALLOC)
+%.o: %.c
 	$(CC) $(CFLAGS) -c $<
 
-$(BIN): $(OBJ) $(JEMALLOC)
-
-$(JEMALLOC):
-	$(MAKE) jemalloc -C ../deps
+$(BIN): $(OBJ)
 
 debug:
 	$(MAKE) OPTIMIZATION="-O0"
@@ -26,6 +22,3 @@ profile:
 
 clean:
 	rm -f $(BIN) $(OBJ)
-
-distclean:
-	$(MAKE) distclean -C ../deps
diff --git a/src/alloc.c b/src/alloc.c
index eb14e37..d3b6444 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -5,7 +5,7 @@
 
 void *cv_raw_malloc(size_t size, const char *file, int line)
 {
-    void *ptr = je_malloc(size);
+    void *ptr = malloc(size);
     if (ptr == NULL) {
         LOG(ERROR, "Fatal: OOM trying to allocate %d bytes at %s:%d", size,
                 file, line);
@@ -16,7 +16,7 @@ void *cv_raw_malloc(size_t size, const char *file, int line)
 
 void *cv_raw_calloc(size_t number, size_t size, const char *file, int line)
 {
-    void *ptr = je_calloc(number, size);
+    void *ptr = calloc(number, size);
     if (ptr == NULL) {
         LOG(ERROR, "Fatal: OOM trying to allocate %d bytes at %s:%d",
                 number * size, file, line);
@@ -27,7 +27,7 @@ void *cv_raw_calloc(size_t number, size_t size, const char *file, int line)
 
 void *cv_raw_realloc(void *ptr, size_t size, const char *file, int line)
 {
-    void *newptr = je_realloc(ptr, size);
+    void *newptr = realloc(ptr, size);
     if (newptr == NULL) {
         LOG(ERROR, "Fatal: OOM trying to allocate %d bytes at %s:%d", size,
                 file, line);
@@ -38,7 +38,7 @@ void *cv_raw_realloc(void *ptr, size_t size, const char *file, int line)
 
 void cv_free(void *ptr)
 {
-    je_free(ptr);
+    free(ptr);
 }
 
 char *cv_raw_strndup(const char *other, size_t size, const char *file, int line)
-- 
2.14.3

