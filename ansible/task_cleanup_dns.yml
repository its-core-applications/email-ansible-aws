---

- name: Fetch resource records
  route53_facts:
    query: record_sets
    start_record_name: "{{ (r53_rrs | default({})).NextRecordName | default(omit) }}"
    max_items: 25
    hosted_zone_id: "{{ subd_zone.Id }}"
  register: r53_rrs

- name: Check if we can connect
  wait_for:
    host: "{{ item.Name }}"
    port: 22
    state: started
    connect_timeout: 1
    timeout: 1
  ignore_errors: true
  register: result
  loop: "{{ r53_rrs.ResourceRecordSets }}"
  loop_control:
    label: "{{ item.Name }}"
  when:
    - item.Type == 'CNAME'
    - item.ResourceRecords.0.Value is match('.+\.compute\.amazonaws\.com')
    - item.Name[:-1] not in hostvars

- name: Delete definitively unused CNAMEs
  route53:
    command: delete
    zone: "{{ subd }}"
    record: "{{ item.item.Name }}"
    type: CNAME
    ttl: "{{ item.item.TTL }}"
    value: "{{ item.item.ResourceRecords.0.Value }}"
  loop: "{{ result.results | select('failed') | list }}"
  loop_control:
    label: "{{ item.item.Name }}"

