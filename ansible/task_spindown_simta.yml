---

- name: Stop simta
  systemd:
    name: simta
    state: stopped

- name: Clean queues
  command: /usr/sbin/simta -C

- name: Lock and load
  vars:
    simqtmp_base: /home/{{ lookup('env', 'USER') }}/simqtmp
    simqtmp: "{{ simqtmp_base }}/inbound/{{ inventory_hostname }}-{{ ansible_facts.date_time.epoch | to_uuid }}"
  block:
    - name: Create local queue storage directory
      delegate_to: localhost
      file:
        dest: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
      loop:
        - "{{ simqtmp_base }}"
        - "{{ simqtmp_base }}/inbound"

    - name: Touch lockfile
      delegate_to: localhost
      file:
        dest: "{{ simqtmp }}.lock"
        state: touch

    - name: Save queue
      synchronize:
        mode: pull
        archive: true
        src: /var/spool/simta/slow/
        dest: "{{ simqtmp }}/"

    - name: Remove lockfile
      delegate_to: localhost
      file:
        dest: "{{ simqtmp }}.lock"
        state: absent

