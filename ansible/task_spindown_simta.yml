---

- name: Stop simta
  systemd:
    name: simta
    state: stopped

- name: Clean queues
  command: /usr/sbin/simta -C

- name: Create local queue storage directory
  delegate_to: localhost
  file:
    dest: /home/ec2-user/simqtmp
    state: directory

- name: Lock and load
  vars:
    simqtmp: "/home/ec2-user/simqtmp/inbound/{{ inventory_hostname }}-{{ ansible_facts.date_time.epoch | to_uuid }}"
  block:
    - name: Touch lockfile
      delegate_to: localhost
      file:
        dest: "{{ simqtmp }}.lock"
        state: touch

    - name: Save queue
      synchronize:
        mode: pull
        archive: true
        src: /var/spool/simta/slow/
        dest: "{{ simqtmp }}/"

    - name: Remove lockfile
      delegate_to: localhost
      file:
        dest: "{{ simqtmp }}.lock"
        state: absent

