- tags:
    - build
    - rpmbuild
  when: role_rpmbuild_done is not defined
  block:
    - name: Install basic build dependencies
      yum:
        name:
          - autoconf
          - automake
          - ccache
          - cmake
          - createrepo
          - gcc-c++
          - git
          - libtool
          - rpmdevtools
          - ruby-devel
          - rubygems
          - setup
        state: present

    # FIXME: this is an ugly hack to prevent an error while installing fpm
    - name: Install ffi
      gem:
        name: ffi
        version: 1.12.2
        user_install: false

    # FIXME: ibid.
    - name: Install git gem
      gem:
        name: git
        version: 1.6.0
        user_install: false

    - name: Install fpm
      gem:
        name: fpm
        user_install: false
        state: latest

    - name: Set up rpmbuild tree
      become: false
      command: rpmdev-setuptree
      args:
        creates: ~/rpmbuild/RPMS

    - name: Also make sure we have a subdir to dump RPMs into
      become: false
      file:
        dest: ~/rpmbuild/RPMS/x86_64/
        state: directory

    - set_fact:
        role_rpmbuild_done: true
