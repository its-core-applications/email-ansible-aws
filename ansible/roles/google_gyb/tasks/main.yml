- tags:
    - google
    - gyb
  block:
    - import_role:
        name: python_venv
      vars:
        venv_name: gyb
        venv_py3: true
        venv_packages:
          - google-api-python-client
          # FIXME: GYB is monkey-patching httplib2 in an incompatible way
          # at the moment.
          - httplib2<0.13.0
          - oauth2client
        venv_sudo_user: collaborate
        venv_wrappers:
          - name: gyb
            target: python
            extra_args: /home/collaborate/GYB/gyb.py --service-account
            
    - name: Install GYB
      become_user: collaborate
      git:
        repo: https://github.com/jay0lee/got-your-back.git
        dest: ~/GYB
        version: v1.27
        force: true

    - name: Configure GYB
      file:
        dest: /home/collaborate/GYB/{{ item }}
        state: touch
        owner: collaborate
        group: collaborate
      loop:
        - noupdatecheck.txt
        - nobrowser.txt

    - name: Copy over GYB service account credentials
      copy:
        dest: "/home/collaborate/GYB/oauth2service.json.b64"
        content: "{{ lookup('hashi_vault', 'secret=secret/google/gyb/oauth2service:value') }}"
        owner: collaborate
        group: root
        mode: "0640"
      register: result

    - name: Decode GYB service account credentials
      shell: "base64 -d /home/collaborate/GYB/oauth2service.json.b64 > /home/collaborate/GYB/oauth2service.json"

    - name: Set permissions on GYB service account credentials
      file:
        dest: "/home/collaborate/GYB/oauth2service.json"
        owner: collaborate
        group: root
        mode: "0640"
