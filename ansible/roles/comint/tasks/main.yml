---

- name: Install comint
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - comint

- name: Create directories
  file:
    dest: "{{ item }}"
    state: directory
    owner: collaborate
    group: nonpeople
    mode: 0775
  with_items:
    - /usr/local/collaboration
    - /usr/local/collaboration/dispatch
    - /usr/local/collaboration/dispatch/local
    - /usr/local/collaboration/nag
    - /usr/local/collaboration/nag/local
    - /usr/local/collaboration/report
    - /usr/local/collaboration/report/local
    - /usr/local/collaboration/report/watchdog.d

- name: Set up monitoring skeleton
  template:
    dest: "/usr/local/collaboration/{{ item }}"
    src: "{{ item }}.j2"
    owner: collaborate
    group: nonpeople
    mode: 0664
  with_items:
    - comint.conf
    - dispatch/dispatch.conf
    - nag/nag.conf
    - report/report.conf

- name: Install basic monitoring scripts
  copy:
    dest: "/usr/local/collaboration/{{ item }}"
    src: "{{ item }}"
    owner: collaborate
    group: nonpeople
    mode: 0755
  with_items:
    - report/watchdog
    - report/watchdog.d/10overrides
    - report/watchdog.d/15runlevel
    - report/watchdog.d/30maxcpu
    - report/watchdog.d/30maxswap
    - report/watchdog.d/30maxvm
    - report/watchdog.d/40orphans
    - report/watchdog.d/40roadkill

- name: Configure basic monitoring scripts
  copy:
    dest: "/usr/local/collaboration/{{ item }}"
    src: "{{ item }}"
    owner: collaborate
    group: nonpeople
    mode: 0644
  with_items:
    - report/watchdog.conf
    - nag/psnag-functions

- name: Set up cron job to run reports
  cron:
    user: collaborate
    minute: 0
    hour: 0
    name: reports
    job: "run-parts /usr/local/collaboration/report"
