- name: Fetch resource records
  route53_info:
    profile: "{{ aws_profile_subd }}"
    query: record_sets
    start_record_name: "{{ r53_rrs.NextRecordName | default(omit) }}"
    max_items: 25
    hosted_zone_id: "{{ subd_zone.Id }}"
  register: r53_rrs

- name: Delete stale CNAMEs
  route53:
    profile: "{{ aws_profile_subd }}"
    command: delete
    zone: "{{ subd }}"
    record: "{{ item.Name }}"
    type: CNAME
    ttl: "{{ item.TTL }}"
    value: "{{ item.ResourceRecords.0.Value }}"
  loop: "{{ r53_rrs.ResourceRecordSets | selectattr('Type', 'equalto', 'CNAME') }}"
  loop_control:
    label: "{{ item.Name }}"
  when:
    - item.ResourceRecords.0.Value is match('.+\.compute\.amazonaws\.com')
    - item.ResourceRecords.0.Value not in hostvars
    - item.Name[:-1] not in hostvars

- name: Delete stale A records
  route53:
    profile: "{{ aws_profile_subd }}"
    command: delete
    zone: "{{ subd }}"
    record: "{{ item.Name }}"
    type: A
    ttl: "{{ item.TTL }}"
    value: "{{ item.ResourceRecords.0.Value }}"
  loop: "{{ r53_rrs.ResourceRecordSets | selectattr('Type', 'equalto', 'A') }}"
  loop_control:
    label: "{{ item.Name }}"
  when:
    - item.ResourceRecords | default([]) | length == 1
    - item.Name[:-1] not in hostvars
    - item.Name is match('[a-z]+-[a-z]+\.[a-z-]+\.' ~ subd ~ '\.')

- name: Delete ACME authorizations
  route53:
    profile: "{{ aws_profile_subd }}"
    command: delete
    zone: "{{ subd }}"
    record: "{{ item.Name }}"
    type: TXT
    ttl: "{{ item.TTL }}"
    value: "'{{ item.ResourceRecords.0.Value }}'"
  loop: "{{ r53_rrs.ResourceRecordSets | selectattr('Type', 'equalto', 'TXT') | selectattr('Name', 'match', '^_acme-challenge\\.') }}"
  loop_control:
    label: "{{ item.Name }}"
  when: item.Name[16:-1] not in hostvars
