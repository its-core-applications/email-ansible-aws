---

- name: Install runtime dependencies for custom plugins
  yum:
    pkg: "{{ item }}"
    state: latest
  with_items:
    - python2-boto3

- name: Install custom plugins
  copy:
    dest: "/etc/sensu/plugins/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0755
  with_items:
    - handler-sns

- name: Create the RabbitMQ vhost for sensu
  rabbitmq_vhost:
    name: /sensu
    state: present

- name: Create the RabbitMQ user for sensu
  rabbitmq_user:
    name: sensu
    state: present
    password: "{{ sensu_rabbitmq_password }}"
    permissions:
      - vhost: /sensu
        configure_priv: .*
        read_priv: .*
        write_priv: .*

- name: Configure sensu server
  template:
    dest: "/etc/sensu/conf.d/{{ item }}"
    src: "{{ item }}.j2"
  with_items:
    - api.json
    - redis.json
    - notification_handlers.json
    - handle_deregistration.json
    - check_cert.json
    - check_clamav.json
    - check_dnsbl.json
    - check_rbldnsd.json
    - check_redis.json
    - check_simta.json
    - check_spamassassin.json
    - check_system.json
  notify: Restart sensu server

- name: Enable sensu server
  systemd:
    name: "{{ item }}"
    enabled: true
  with_items:
    - sensu-server
    - sensu-api
  notify: Restart sensu server

- name: Install sensu plugins
  become_user: sensu
  gem:
    name: "{{ item }}"
    executable: /opt/sensu/embedded/bin/gem
    state: latest
  with_items:
    - sensu-plugins-sensu
    - sensu-plugins-graphite

- name: Configure ELB checks
  sensu_check:
    name: "elb-{{ item }}"
    path: /etc/sensu/conf.d/check_elb.json
    command: "{{ sensu_plugin_path }}/check-elb-nodes.rb -r {{ aws_region }} -n {{ item }} -W 66 -C 33"
    interval: 120
    timeout: 90
    source: "{{ item }}.{{ subd }}"
    subscribers:
      - roundrobin:Class_mx
  with_items: "{{ mx_names }}"
  notify: Restart sensu server

