---

- name: Create SNS topic for paging
  delegate_to: localhost
  become: false
  sns_topic:
    region: "{{ aws_region }}"
    name: oncall
    display_name: ONC
    state: present
    purge_subscriptions: false
    subscriptions:
      - endpoint: "{{ lookup('hashi_vault', 'secret=secret/phone/pager') }}"
        protocol: 'sms'

- name: Create SNS topic for email
  delegate_to: localhost
  become: false
  sns_topic:
    region: "{{ aws_region }}"
    name: rootmail
    display_name: rootmail
    state: present
    purge_subscriptions: false
    subscriptions:
      - endpoint: "{{ ops_rootmail }}"
        protocol: 'email'

- name: Install custom plugins
  copy:
    dest: "/etc/sensu/plugins/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0755
  with_items:
    - handler-sns

- name: Create the RabbitMQ vhost for sensu
  rabbitmq_vhost:
    name: /sensu
    state: present

- name: Create the RabbitMQ user for sensu
  rabbitmq_user:
    name: sensu
    state: present
    password: "{{ lookup('hashi_vault', 'secret=secret/sensu/rabbitmq') }}"
    permissions:
      - vhost: /sensu
        configure_priv: .*
        read_priv: .*
        write_priv: .*

- name: Configure sensu server
  template:
    dest: "/etc/sensu/conf.d/{{ item }}"
    src: "{{ item }}.j2"
  with_items:
    - api.json
    - redis.json
    - sensu_plugin.json
    - notification_handlers.json
    - handle_deregistration.json
    - check_aws.json
    - check_cert.json
    - check_clamav.json
    - check_dnsbl.json
    - check_elb.json
    - check_rbldnsd.json
    - check_redis.json
    - check_rspamd.json
    - check_simta.json
    - check_system.json
  notify: Restart sensu server

- name: Enable sensu server
  systemd:
    name: "{{ item }}"
    enabled: true
  with_items:
    - sensu-server
    - sensu-api
  notify: Restart sensu server

