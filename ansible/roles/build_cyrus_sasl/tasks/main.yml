---

- name: Install build dependencies
  yum: name={{ item }} state=present
  with_items:
    - gdbm-devel
    - groff
    - krb5-devel
    - openssl-devel
    - pam-devel
    - zlib-devel

- name: Install spec file 
  become: false
  copy: src=cyrus-sasl.spec dest=~/cyrus-sasl.spec

- name: Fetch sources 
  become: false
  shell: spectool -g -R ~/cyrus-sasl.spec

- name: Install non-fetchable sources
  become: false
  copy: src=sources/{{ item }} dest=~/rpmbuild/SOURCES/{{ item }}
  with_items:
    - cyrus-sasl-2.1.20-saslauthd.conf-path.patch
    - cyrus-sasl-2.1.21-sizes.patch
    - cyrus-sasl-2.1.22-kerberos4.patch
    - cyrus-sasl-2.1.23-man.patch
    - cyrus-sasl-2.1.25-no_rpath.patch
    - cyrus-sasl-2.1.26-error-message-when-config-has-typo.patch
    - cyrus-sasl-2.1.26-gssapi-non-encrypt.patch
    - cyrus-sasl-2.1.26-gssapi-use-per-connection-mutex.patch
    - cyrus-sasl-2.1.26-handle-single-character-mechanisms.patch
    - cyrus-sasl-2.1.26-keytab.patch
    - cyrus-sasl-2.1.26-make-client-thread-sage.patch
    - cyrus-sasl-2.1.26-md5global.patch
    - cyrus-sasl-2.1.26-null-crypt.patch
    - cyrus-sasl-2.1.26-obsolete-macro.patch
    - cyrus-sasl-2.1.26-ppc.patch
    - cyrus-sasl-2.1.26-prefer-SCRAM-SHA-1-over-PLAIN.patch
    - cyrus-sasl-2.1.26-release-server_creds.patch
    - cyrus-sasl-2.1.26-relro.patch
    - cyrus-sasl-2.1.26-revert-gssapi-flags.patch
    - cyrus-sasl-2.1.26-servername.patch
    - cyrus-sasl-2.1.26-size_t.patch
    - cyrus-sasl-2.1.26-sql.patch
    - cyrus-sasl-2.1.26-user-specified-logging.patch
    - cyrus-sasl-2.1.26-warnings.patch
    - saslauthd.service
    - saslauthd.sysconfig

- name: Build RPM
  become: false
  shell: rpmbuild -ba ~/cyrus-sasl.spec
  environment:
    QA_RPATHS: 1
  notify: Update yum repository
