---

- name: Create nonpeople group
  group:
    name: nonpeople
    gid: 1101
    state: present
  tags: mutable

- name: Create non-person accounts
  user:
    name: "{{ item.name }}"
    group: nonpeople
    home: "/home/{{ item.name }}"
    shell: /bin/sh
    uid: "{{ item.uid }}"
    comment: "{{ item.comment }}"
    state: present
  with_items: "{{ nonperson_accounts }}"
  tags: mutable

- name: Create .ssh directory for non-person accounts
  file:
    dest: "/home/{{ item.name }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    group: nonpeople
    mode: 0755
  with_items: "{{ nonperson_accounts }}"
  tags: mutable

- name: Install authorized_keys for non-person accounts
  copy:
    dest: "/home/{{ item.name }}/.ssh/authorized_keys"
    src: "authorized_keys.{{ item.name }}"
    owner: "{{ item.name }}"
    group: nonpeople
    mode: 0444
  with_items: "{{ nonperson_accounts | selectattr('ssh', 'defined') | selectattr('ssh') | list }}"
  tags: mutable
