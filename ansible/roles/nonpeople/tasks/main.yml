---

- tags:
    - nonpeople
    - accounts
  block:
    - name: Create nonpeople group
      group:
        name: nonpeople
        gid: 1101
        state: present
      tags: mutable

    - name: Create non-person accounts
      user:
        name: "{{ item.name }}"
        group: nonpeople
        home: "{{ item.home is defined | ternary(item.home, '/home/' ~ item.name) }}"
        shell: /bin/sh
        uid: "{{ item.uid }}"
        comment: "{{ item.comment }}"
        state: present
      loop: "{{ nonperson_accounts }}"
      tags: mutable

    - name: Create .ssh directory for non-person accounts
      file:
        dest: ~{{ item.name }}/.ssh
        state: directory
        owner: "{{ item.name }}"
        group: nonpeople
        mode: "0755"
      loop: "{{ nonperson_accounts }}"
      tags: mutable

    - name: Install authorized_keys for non-person accounts
      copy:
        dest: ~{{ item.name }}/.ssh/authorized_keys
        src: authorized_keys.{{ item.name }}
        owner: "{{ item.name }}"
        group: nonpeople
        mode: "0444"
      loop: "{{ nonperson_accounts | selectattr('ssh', 'defined') | selectattr('ssh') | list }}"
      tags: mutable

