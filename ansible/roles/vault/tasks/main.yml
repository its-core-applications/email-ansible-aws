- tags:
    - vault
  block:
    - import_role:
        name: letsencrypt
      vars:
        certificate: vault.{{ subd }}
        le_services:
          - vault

    - name: Install vault
      yum:
        name: vault
        state: latest
      notify: Restart vault

    - name: Configure vault server
      template:
        dest: /etc/vault.hcl
        src: vault.hcl.j2
        owner: root
        group: root
        mode: "0644"
      notify: Restart vault

    - name: Configure vault service
      copy:
        dest: /etc/systemd/system/vault.service
        src: vault.service
        owner: root
        group: root
        mode: "0644"
      notify: Restart vault

    - name: Enable vault service
      service:
        name: vault
        enabled: true

    - name: Install custom monitoring script
      copy:
        dest: "{{ comint_base }}/check-vault-seal"
        src: check-vault-seal
        owner: collaborate
        group: collaborate
        mode: "0755"
