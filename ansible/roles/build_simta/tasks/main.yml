---

- meta: flush_handlers

- name: Install build dependencies
  yum: pkg={{ item }} state=present
  with_items:
    - jemalloc-devel
    - libsnet-devel
    - denser-devel
    - procmail
    - lmdb-devel
    - openldap-devel
    - tcp_wrappers-devel
    - libopendkim
    - libopendkim-devel
    - sendmail-devel
    - libidn-devel

- name: Disable sendmail
  service: name=sendmail enabled=no state=stopped
  tags: configuration

- name: Update the simta source tree
  become: false
  git:
    repo: git://scm.marwnad.com/umich/simta.git
    version: "{{ build_simta_version }}"
    dest: ~/simta
    update: yes
    force: yes

- name: Build simta RPM (autoreconf)
  become: false
  command: chdir=~/simta autoreconf -fiv

- name: Build simta RPM (configure)
  become: false
  command: chdir=~/simta ./configure

- name: Build simta RPM (make rpm)
  become: false
  command: chdir=~/simta make rpm
  notify: Update yum repository
