- tags:
    - zabbix
    - zabbix_agent
  block:
    - name: Install Zabbix repo
      ansible.builtin.yum:
        name: https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm
        state: present
        disable_gpg_check: true

    # EPEL packages are very incompatible with the official packages, and also
    # have a higher epoch so they shadow them despite being older versions.
    - name: Disable zabbix packages from EPEL
      ansible.builtin.command: dnf config-manager --save --setopt='epel.exclude=zabbix*'

    - name: Install Zabbix agent
      ansible.builtin.yum:
        name:
          - zabbix-agent2
        state: latest

    - name: Configure Zabbix agent
      ansible.builtin.template:
        dest: /etc/zabbix/zabbix_agent2.conf
        src: zabbix_agent2.conf.j2
        owner: root
        group: root
        mode: "0644"

    - name: Start Zabbix agent
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: restarted
        enabled: true
        daemon_reload: true
