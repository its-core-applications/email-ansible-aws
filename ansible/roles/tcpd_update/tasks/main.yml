- tags:
    - tcpd_update
  block:
    - import_role:
        name: datastore_fetch

    - name: Install SSH private key
      copy:
        dest: /root/.ssh/id_rsa.rbldnsd
        content: "{{ lookup('flowerysong.hvault.kv', 'ssh/rbldnsd').value }}"
        owner: root
        group: root
        mode: "0400"

    - name: Install sync script
      copy:
        dest: /usr/local/sbin/tcpd-update
        src: tcpd-update
        owner: root
        group: root
        mode: "0755"

    # We can't just set `simta_tcpwrappers: true` because that tries to manage
    # /etc/hosts.allow as well.
    - name: Configure hosts.deny
      copy:
        dest: /etc/hosts.deny
        src: hosts.deny
        owner: root
        group: root
        mode: "0664"

    - name: Sync /etc/hosts.allow
      command: /usr/local/sbin/tcpd-update -d http://datastore.{{ subd }}
      environment:
        RETURN_RC: 1
      register: result
      until: result is success
      retries: 30
      delay: 10

    - name: Schedule syncing
      template:
        dest: /etc/cron.d/tcpd-update
        src: tcpd-update.cron.j2
        owner: root
        group: root
        mode: "0644"
