---

dependencies:
  - { role: rpmbuild, tags: always }
  - { role: localrepo, tags: always }

  - role: build_sensu_plugins
    tags: sensu

  - role: build_rpm_prebuilt
    tags:
      - cjose
      - mod_auth_openidc
    build_data:
      name: cjose
      rpm: cjose-0.4.1-1.el7.centos.x86_64.rpm
      url: 'https://github.com/pingidentity/mod_auth_openidc/releases/download/v2.1.3/cjose-0.4.1-1.el7.centos.x86_64.rpm'
      checksum: 'sha256:37a93d7cd98012915a0940f281388b22a12ea325e2b8f5d83e89278ca9da21a5'

  - role: build_rpm_spec
    tags:
      - sasl
      - libsnet
      - simta
    build_data:
      name: cyrus-sasl
      deps:
        - gdbm-devel
        - groff
        - krb5-devel
        - openssl-devel
        - pam-devel
        - zlib-devel
      extra_sources:
        - cyrus-sasl-2.1.20-saslauthd.conf-path.patch
        - cyrus-sasl-2.1.21-sizes.patch
        - cyrus-sasl-2.1.22-kerberos4.patch
        - cyrus-sasl-2.1.23-man.patch
        - cyrus-sasl-2.1.25-no_rpath.patch
        - cyrus-sasl-2.1.26-error-message-when-config-has-typo.patch
        - cyrus-sasl-2.1.26-gssapi-non-encrypt.patch
        - cyrus-sasl-2.1.26-gssapi-use-per-connection-mutex.patch
        - cyrus-sasl-2.1.26-handle-single-character-mechanisms.patch
        - cyrus-sasl-2.1.26-keytab.patch
        - cyrus-sasl-2.1.26-make-client-thread-sage.patch
        - cyrus-sasl-2.1.26-md5global.patch
        - cyrus-sasl-2.1.26-null-crypt.patch
        - cyrus-sasl-2.1.26-obsolete-macro.patch
        - cyrus-sasl-2.1.26-ppc.patch
        - cyrus-sasl-2.1.26-prefer-SCRAM-SHA-1-over-PLAIN.patch
        - cyrus-sasl-2.1.26-release-server_creds.patch
        - cyrus-sasl-2.1.26-relro.patch
        - cyrus-sasl-2.1.26-revert-gssapi-flags.patch
        - cyrus-sasl-2.1.26-servername.patch
        - cyrus-sasl-2.1.26-size_t.patch
        - cyrus-sasl-2.1.26-sql.patch
        - cyrus-sasl-2.1.26-user-specified-logging.patch
        - cyrus-sasl-2.1.26-warnings.patch
        - saslauthd.service
        - saslauthd.sysconfig

  - role: build_rpm_git
    tags:
      - denser
      - simta
    build_data:
      name: denser
      repo: https://github.com/simta/denser.git
      deps:
        - openssl-devel

  - role: build_rpm_spec
    tags:
      - jemalloc
      - simta
      - redis
    build_data:
      name: jemalloc

  - role: build_rpm_git
    tags:
      - libsnet
      - simta
    build_data:
      name: libsnet
      repo: https://github.com/simta/libsnet.git
      deps:
        - cyrus-sasl-devel
        - openssl-devel

  - role: build_libucl
    tags:
      - libucl
      - simvacation

  - role: build_rpm_git
    tags:
      - urcl
      - penaltybox
      - simvacation
    build_data:
      name: urcl
      repo: https://github.com/simta/urcl.git
      deps:
        - hiredis-devel

  - role: build_rpm_spec
    tags: clamav
    build_data:
      name: clamav
      deps:
        - bzip2-devel
        - curl-devel
        - gmp-devel
        - libxml2-devel
        - ncurses-devel
        - sendmail-devel
        - tcp_wrappers-devel
      extra_sources:
        - README.fedora
        - clamav-0.98-umask.patch
        - clamav-0.98.6-jitoff.patch
        - clamav-0.99-umich-safereload.patch
        - clamav-milter.systemd
        - clamav-notify-servers
        - clamav-update.logrotate
        - clamd-README
        - clamd-gen
        - clamd-wrapper
        - clamd.logrotate
        - clamd.sysconfig
        - freshclam.sysconfig
        - llvm-glibc.patch

  - role: build_rpm_git
    tags: comint
    build_data:
      name: comint
      repo: http://scm.marwnad.com/umich/comint.git/

  - role: build_rpm_spec
    tags: dash
    build_data:
      name: dash
      extra_sources:
        - dash-0.5.7-format-security.patch

  - role: build_rpm_git
    tags:
      - google
      - google-admin-kit
    build_data:
      name: google-admin-kit
      repo: https://bitbucket.org/its-application-delivery/google-admin-kit.git

  - role: build_rpm_git
    tags:
      - google
      - google-admin-kit-umextras
    build_data:
      name: google-admin-kit-umextras
      repo: https://bitbucket.org/its-application-delivery/google-admin-kit-um-extras.git

  - role: build_rpm_prebuilt
    tags: mod_auth_openidc
    build_data:
      name: mod_auth_openidc
      rpm: mod_auth_openidc-2.1.6-1.el7.centos.x86_64.rpm
      url: 'https://github.com/pingidentity/mod_auth_openidc/releases/download/v2.1.6/mod_auth_openidc-2.1.6-1.el7.centos.x86_64.rpm'
      checksum: 'sha256:8d444197fb481a5d48bcd7c6f3881b49b505072b85b75888d47cd751501290bf'

  - role: build_rpm_spec
    tags: nmh
    build_data:
      name: nmh
      deps:
        - flex
        - ncurses-devel

  - role: build_rpm_git
    tags: penaltybox
    build_data:
      name: penaltybox
      repo: https://github.com/simta/penaltybox.git
      deps:
        - urcl-devel

  - role: build_rpm_spec
    tags: redis
    build_data:
      name: redis
      deps:
        - jemalloc-devel
      extra_sources:
        - redis-3.2.5-use-system-jemalloc.patch
        - redis-limit-init
        - redis-limit-systemd
        - redis-sentinel.init
        - redis-sentinel.service
        - redis-shutdown
        - redis.init
        - redis.logrotate
        - redis.service
        - redis.tmpfiles

  - role: build_rpm_git
    tags: simta
    build_data:
      name: simta
      repo: https://github.com/simta/simta.git
      version: master
      deps:
        - denser-devel
        - jemalloc-devel
        - libidn-devel
        - libopendkim
        - libopendkim-devel
        - libsnet-devel
        - lmdb-devel
        - openldap-devel
        - procmail
        - sendmail-devel
        - tcp_wrappers-devel

  - role: build_rpm_git
    tags: simta-admin
    build_data:
      name: simta-admin
      repo: https://github.com/simta/simta-admin.git

  - role: build_rpm_git
    tags: simta-mscan
    build_data:
      name: simta-mscan
      repo: https://github.com/simta/simta-mscan.git

  - role: build_rpm_git
    tags: simvacation
    build_data:
      name: simvacation
      repo: https://github.com/simta/simvacation.git
      deps:
        - libucl-devel
        - lmdb-devel
        - openldap-devel
        - urcl-devel

  - role: build_rpm_prebuilt
    tags: splunk
    build_data:
      name: splunk
      rpm: splunkforwarder-6.6.1-aeae3fe0c5af-linux-2.6-x86_64.rpm
      url: 'https://www.splunk.com/bin/splunk/DownloadActivityServlet?architecture=x86_64&platform=linux&version=6.6.1&product=universalforwarder&filename=splunkforwarder-6.6.1-aeae3fe0c5af-linux-2.6-x86_64.rpm&wget=true'
      checksum: 'md5:4e7ce1b21dd3ee3f09fad2626a07cc1d'

  - role: build_rpm_spec
    tags: sshguard
    build_data:
      name: sshguard
      extra_sources:
        - sshguard.service

  - role: build_rpm_python
    tags:
      - google
      - gak_utils
    build_data:
      name: umich_gak_utils
      repo: https://bitbucket.org/its-application-delivery/google-admin-kit-utilities.git

  - role: build_rpm_python
    tags:
      - box
    build_data:
      name: umich_box_utils
      repo: https://bitbucket.org/its-application-delivery/box-utilities/

  - { role: s3repo_build, tags: always }
