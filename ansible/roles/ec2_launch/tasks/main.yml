- tags:
    - ec2_launch
    - ec2
    - launch
  become: false
  vars:
    launch_groups_default:
       - "{{ launch_subnet_type | default('public') }}-default"
  block:
    - name: Check region guardrail
      assert:
        that: launch_class in aws_region_layout[aws_status][aws_region]
        fail_msg: If you're really sure you want to launch this instance, modify aws_region_layout to allow it.

    - import_role:
        name: iam_profiles

    - import_role:
        name: ec2_security_groups
      vars:
        ec2sg_groups: "{{ launch_groups_default | union(launch_groups) }}"

    - when: bootstrap == false
      block:
        - name: Set keypair facts
          set_fact:
            aws_ssh_key: "{{ aws_resource_prefix }} {{ (public_key | hash('sha1'))[:6] }}"
            aws_ssh_key_material: "{{ public_key }}"
          vars:
            public_key: "{{ lookup('hashi_vault', 'secret=secret/ssh/' ~ ansible_user ~ ':public') }}"

        - name: Create keypair
          ec2_key:
            region: "{{ aws_region }}"
            profile: "{{ aws_profile }}"
            name: "{{ aws_ssh_key }}"
            key_material: "{{ aws_ssh_key_material }}"
            force: true

    - name: Get AMI data
      ec2_ami_info:
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        owners: self
        filters:
          "tag:os": "{{ launch_os | default('amzn2') }}"
          "tag:image_type": "{{ launch_ami_class | default(launch_class) | replace('-', '_') }}"
      register: find_ami_facts

    - name: Find latest AMI
      set_fact:
        find_ami: "{{ find_ami_facts.images | sort(attribute='creation_date') | last }}"

    - import_role:
        name: ec2_find_subnets

    - name: Create {{ launch_class }} instance(s)
      ec2_instance:
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        security_groups: "{{ launch_groups_default | union(launch_groups) | map('regex_replace', '^', aws_resource_prefix ~ ' ') | list }}"
        key_name: "{{ aws_ssh_key }}"
        instance_type: "{{ aws_region_layout[aws_status][aws_region][launch_class].size | default(aws_instance_default[aws_status]) }}"
        vpc_subnet_id: "{{ (launch_subnet | default(ec2_subnets[aws_region][item % (ec2_subnets[aws_region] | length)])).id }}"
        network:
          assign_public_ip: "{{ launch_class != 'syslog' or aws_profile == 'umcollab' }}"
          delete_on_termination: true
        image_id: "{{ find_ami.image_id }}"
        instance_role: "{{ aws_resource_prefix }}_{{ launch_profile | default('standard') }}"
        tags: "{{ launch_tags_default | combine(launch_tags) }}"
        filters:
          "tag:Name": We never want to match an existing instance, and this should ensure that.
        wait: false
      vars:
        ec2_subnets: "{{ hostvars[inventory_hostname]['ec2_subnets_' ~ (launch_subnet_type | default('public'))] }}"
        launch_count_default: "{{ aws_region_layout[aws_status][aws_region][launch_class].count | default(1) - (groups['Class_' ~ launch_class | replace('-', '_')] | intersect(aws_region_group) | intersect(groups.Status_production | union(groups.Status_spinup) | union(groups.Status_development)) | length) }}"
        launch_tags_default:
          Class: "{{ launch_class }}"
          Status: spinup
          BusinessOwner: "{{ aws_resource_owner }}"
      loop: "{{ range(launch_count | default(launch_count_default) | int) | list }}"
      ignore_errors: true
      register: ec2

    - name: Wait for launched instances to have hostnames
      ec2_instance_info:
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        instance_ids: "{{ ec2_instances }}"
      vars:
        ec2_instances: "{{ ec2.results | selectattr('instance_ids', 'defined') | map(attribute='instance_ids') | flatten }}"
      when: ec2_instances | length
      ignore_errors: true
      register: result
      until: (result.instances | map(attribute='tags.CustomDNSName') | select('defined') | list | length) == (ec2_instances | length)
      retries: 20
      delay: 15

    - name: Mark laggard instances as spundown
      ec2_tag:
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        resource: "{{ item.instance_id }}"
        tags:
          Status: spundown
      loop: "{{ result.instances | default([]) | rejectattr('tags.CustomDNSName', 'defined') | list }}"
      loop_control:
        label: "{{ item.instance_id }}"

    - meta: refresh_inventory

    - name: Flush DNS cache
      command: unbound-control reload
      become: true
      when:
        - result is not skipped
        - lookup('env', 'USER') == 'ec2-user'

    - name: Wait for launched instances to be available
      delegate_to: "{{ item.tags.CustomDNSName }}"
      wait_for_connection:
        delay: 2
        sleep: 2
        timeout: 300
      when: launch_wait | default(true)
      loop: "{{ result.instances | default([]) | selectattr('tags.CustomDNSName', 'defined') | list }}"
      loop_control:
        label: "{{ item.instance_id }}"

