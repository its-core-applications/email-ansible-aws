---

- name: Install redis
  yum:
    pkg: redis
    state: latest

- name: Install management scripts
  copy:
    dest: "/usr/local/sbin/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0755
  items:
    - redis-manage
    - redis-remove

- name: Run provision script
  command: "/usr/local/sbin/redis-manage {{ groups.tag_redis_yes | map('extract', hostvars, 'ec2_private_ip_address') | join(' ') }}"
  register: result
  failed_when: "result.rc > 1"
  changed_when: "result.rc == 0"
  when: groups.tag_redis_yes is defined

- name: Register sensu proxy client for redis cluster
  uri:
    url: http://syslog.{{ subd }}:4567/clients
    method: POST
    body_format: json
    body:
      name: "pink.{{ subd }}"
      address: ""
      subscriptions:
        - Class_redis_cluster
        - Status_production
    status_code: 201

