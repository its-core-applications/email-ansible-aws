---

- name: Install redis
  yum:
    pkg: redis
    state: latest

- name: Install management scripts
  copy:
    dest: "/usr/local/sbin/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0755
  items:
    - redis-manage
    - redis-remove

- name: Run provision script
  command: "/usr/local/sbin/redis-manage {{ groups.tag_redis_yes | map('extract', hostvars, 'ec2_private_ip_address') | join(' ') }}"
  register: result
  failed_when: "result.rc > 1"
  changed_when: "result.rc == 0"
  when: groups.tag_redis_yes is defined

- name: Schedule provision script runs
  cron:
    name: redis-manage
    user: ec2-user
    minute: "*/20"
    job: ". ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/master.yml --tags redis"
