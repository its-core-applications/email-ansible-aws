---

- name: Create carbon filesystem
  filesystem:
    dev: /dev/xvdf
    fstype: xfs
    force: false

- name: Mount carbon filesystem
  mount:
    name: /var/lib/carbon
    src: /dev/xvdf
    fstype: xfs
    state: mounted

- name: Install carbon
  yum:
    name: python-carbon
    state: latest
  notify: Restart carbon

- name: Fix whisper file permissions
  file:
    dest: /var/lib/carbon
    state: directory
    owner: carbon
    group: carbon
    recurse: true

- name: Configure carbon
  template:
    dest: "/etc/carbon/{{ item }}"
    src: "{{ item }}.j2"
    owner: root
    group: root
    mode: 0644
  loop:
    - carbon.conf
    - aggregation-rules.conf
    - rewrite-rules.conf
    - storage-aggregation.conf
    - storage-schemas.conf
    - blacklist.conf
  notify: Restart carbon

- name: Enable carbon daemons
  systemd:
    name: "{{ item }}"
    enabled: true
  loop:
    - carbon-cache
    - carbon-aggregator
  notify: Restart carbon

- name: Schedule cleanup of old whisper files
  copy:
    dest: /etc/cron.daily/carbon
    src: carbon.cron
    owner: root
    group: root
    mode: 0755

