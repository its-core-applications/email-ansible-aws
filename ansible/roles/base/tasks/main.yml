---

- name: Disable SELinux
  selinux:
    state: disabled

- name: Configure sshd
  copy:
    dest: /etc/ssh/sshd_config
    src: sshd_config
    owner: root
    group: root
    mode: 0644
  notify: Restart sshd

- name: Configure sudoers
  copy:
    dest: /etc/sudoers
    src: sudoers
    owner: root
    group: root
    mode: 0440
    validate: 'visudo -cf %s'
  tags: mutable

- name: Configure cloud-init
  copy:
    dest: /etc/cloud/cloud.cfg
    src: cloud.cfg
    owner: root
    group: root
    mode: 0644

# Disable predictable network interface names
- name: Configure grub
  copy:
    dest: /etc/default/grub
    src: grub
    owner: root
    group: root
    mode: 0640
  register: result

- name: Rebuild grub.cfg
  command: grub2-mkconfig -o /boot/grub2/grub.cfg
  when: result is changed

- name: Set correct timezone
  timezone:
    name: America/Detroit

- name: Customize environment
  copy:
    dest: /etc/profile.d/99_custom.sh
    src: profile.sh
    owner: root
    group: root
    mode: 0644

- name: Remove RHEL file cruft
  file:
    dest: "{{ item }}"
    state: absent
  loop:
    - /etc/cron.daily/rhsmd
    - /etc/motd

- name: Configure tmux
  copy:
    dest: /etc/tmux.conf
    src: tmux.conf
    owner: root
    group: root
    mode: 0644

- name: Set kernel.core_pattern
  sysctl:
    name: kernel.core_pattern
    value: /var/tmp/%e.core.%p
    reload: true
    ignoreerrors: true

- name: Set fs.suid_dumpable
  sysctl:
    name: fs.suid_dumpable
    value: 2
    reload: true
    ignoreerrors: true

- name: Set vm.overcommit_memory
  sysctl:
    name: vm.overcommit_memory
    value: 1
    reload: true
    ignoreerrors: true

- name: Raise corefile limits
  copy:
    dest: /etc/security/limits.d/core.conf
    src: core.conf
    owner: root
    group: root
    mode: 0644

- name: Configure cron scheduled jobs
  copy:
    dest: /etc/cron.d/dailyjobs
    src: dailyjobs.cron
    owner: root
    group: root
    mode: 0644

- name: Configure OpenSSH certificate generation
  copy:
    dest: "/etc/pki/tls/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  loop:
    - openssl.cnf
    - openssl-san.cnf

