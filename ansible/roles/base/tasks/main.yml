---

- name: Disable SELinux
  selinux:
    state: disabled

- name: Configure sshd
  copy:
    dest: /etc/ssh/sshd_config
    src: sshd_config
    owner: root
    group: root
    mode: 0644
  notify: Restart sshd

- name: Configure sudoers
  copy:
    dest: /etc/sudoers
    src: sudoers
    owner: root
    group: root
    mode: 440

- name: Install basic QoL packages
  yum:
    pkg: "{{ item }}"
    state: present
  with_items:
    - awscli
    - bind-utils
    - cronie-noanacron
    - expect
    - git
    - krb5-workstation
    - lsof
    - man
    - mosh
    - nc
    - openldap-clients
    - pv
    - python-boto
    - python-pip
    - rsyslog-relp
    - strace
    - sysstat
    - telnet
    - tmux
    - vim
    - wget
    - whois

- name: Uninstall unwanted packages
  yum:
    pkg: "{{ item }}"
    state: absent
  with_items:
    - cronie-anacron
    - postfix

# Only for the fake hostname that packer uses when building the base image
- name: Upgrade all packages
  yum:
    pkg: "*"
    state: latest
  when: inventory_hostname == "base"

- name: Configure tmux
  copy:
    dest: /etc/tmux.conf
    src: tmux.conf
    owner: root
    group: root
    mode: 0644

- name: Set kernel.core_pattern
  sysctl:
    name: kernel.core_pattern
    value: /var/tmp/%e.core.%p
    reload: yes
    ignoreerrors: yes

- name: Set fs.suid_dumpable
  sysctl:
    name: fs.suid_dumpable
    value: 2
    reload: yes
    ignoreerrors: yes

- name: Raise corefile limits
  copy:
    dest: /etc/security/limits.d/core.conf
    src: core.conf
    owner: root
    group: root
    mode: 0644

- name: Configure systemd-journald
  copy:
    dest: /etc/systemd/journald.conf
    src: journald.conf
    owner: root
    group: root
    mode: 0644
  notify: Restart systemd-journald

- name: Configure rsyslog
  copy:
    dest: /etc/rsyslog.conf
    src: rsyslog.conf
    owner: root
    group: root
    mode: 0644
  notify: Restart rsyslog

- name: Create /etc/systemd/system/rsyslog.service.d
  file:
    dest: /etc/systemd/system/rsyslog.service.d
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Configure rsyslog umask
  copy:
    dest: /etc/systemd/system/rsyslog.service.d/umask.conf
    src: rsyslog.umask
    owner: root
    group: root
    mode: 0644
  notify: Restart rsyslog

- name: Remove RHEL rsyslog cruft
  file:
    dest: "{{ item }}"
    state: absent
  with_items:
    - /etc/rsyslog.d/21-cloudinit.conf
    - /etc/rsyslog.d/listen.conf
  notify: Restart rsyslog

- name: Configure cron scheduled jobs
  copy:
    dest: /etc/cron.d/dailyjobs
    src: dailyjobs.cron
    owner: root
    group: root
    mode: 0644

- name: Configure logrotate
  copy:
    dest: /etc/logrotate.conf
    src: logrotate.conf
    owner: root
    group: root
    mode: 0644

- name: Configure logrotate for syslog files
  copy:
    dest: /etc/logrotate.d/syslog
    src: logrotate.syslog
    owner: root
    group: root
    mode: 0644

- name: Install data files
  copy:
    dest: "/usr/share/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - hostname-prefixes
    - hostname-prefixes-egress
    - hostname-prefixes-mx
    - hostname-prefixes-relay
    - hostname-prefixes-smtp
    - hostname-suffixes
    - hostname-suffixes-mx-test

- name: Install scripts
  template:
    dest: "/usr/local/sbin/{{ item }}"
    src: "{{ item }}.j2"
    owner: root
    group: root
    mode: 0755
  with_items:
    - dynhostname

- name: Install units
  copy: 
    dest: "/etc/systemd/system/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - dynhostname.service

- name: Enable dynhostname
  service:
    name: dynhostname
    enabled: yes

- name: Schedule dynhostname public IP re-check
  copy:
    dest: /etc/cron.d/dynhostname
    src: dynhostname.cron
    owner: root
    group: root
    mode: 0644
