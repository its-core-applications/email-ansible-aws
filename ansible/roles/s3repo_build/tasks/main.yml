---

- meta: flush_handlers

- name: Create repo cache directory
  file:
    dest: /var/cache/{{ yum_hostname }}
    state: directory
    owner: root
    group: root
    mode: 0755
  tags: configuration

- name: Find files in S3
  s3:
    bucket: "{{ yum_hostname }}"
    region: "{{ yum_aws_region }}"
    mode: list
    prefix: "{{ ansible_distribution | lower }}/{{ ansible_distribution_major_version }}/"
  register: find_s3
  tags: s3

- name: Download files from S3
  s3:
    bucket: "{{ yum_hostname }}"
    region: "{{ yum_aws_region }}"
    mode: get
    object: "{{ item }}"
    dest: /var/cache/{{ yum_hostname }}/{{ item | basename }}
    overwrite: different
  with_items: "{{ find_s3.s3_keys }}"
  when: item | match(".*\\.rpm")
  tags: s3

- name: Build repodata
  command: createrepo --database --update /var/cache/{{ yum_hostname }}/
  tags: yum

- name: Find repodata files
  find: paths=/var/cache/{{ yum_hostname }}/repodata/
  register: find_repodata
  tags: yum

- name: Upload repodata
  s3:
    bucket: "{{ yum_hostname }}"
    region: "{{ yum_aws_region }}"
    mode: put
    permission: public-read
    object: "{{ ansible_distribution | lower }}/{{ ansible_distribution_major_version }}/repodata/{{ item.path | basename }}"
    src: "{{ item.path }}"
    overwrite: different
  with_items: "{{ find_repodata.files }}"
  tags: s3
