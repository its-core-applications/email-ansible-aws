---

- name: Install build dependencies
  yum: name={{ item }} state=present
  with_items:
    - bzip2-devel
    - curl-devel
    - gmp-devel
    - libxml2-devel
    - ncurses-devel
  tags: packageinstall

- name: Install spec file 
  become: false
  copy: src=clamav.spec dest=~/clamav.spec
  tags: build

- name: Fetch sources 
  become: false
  shell: spectool -g -R ~/clamav.spec
  tags: build

- name: Install non-fetchable sources
  become: false
  copy: src=sources/{{ item }} dest=~/rpmbuild/SOURCES/{{ item }}
  with_items:
    - clamav-0.99-umich-safereload.patch
    - clamav-0.98-umask.patch
    - clamav-0.98.6-jitoff.patch
    - llvm-glibc.patch
    - clamav-milter.systemd
    - clamav-notify-servers  
    - clamav-update.logrotate
    - clamd-gen
    - clamd.logrotate
    - clamd-README
    - clamd.sysconfig
    - clamd-wrapper
    - freshclam.sysconfig
    - README.fedora
  tags: build

- name: Build ClamAV RPM
  become: false
  shell: rpmbuild -ba ~/clamav.spec
  notify: Update yum repository
  tags: build
