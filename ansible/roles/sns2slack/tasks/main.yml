- tags:
    - sns
    - slack
  delegate_to: localhost
  block:
    - import_role:
        name: aws_get_accountinfo

    - import_role:
        name: lambda_function
      vars:
        lambda_name: sns2slack
        lambda_description: Forward SNS messages to Slack
        lambda_reqs: requests
        lambda_handler: sns2slack.handler
        lambda_env:
          WEBHOOK_URL: "{{ lookup('hashi_vault', 'secret=secret/slack:value') }}"

    - name: Create Lambda policy for SNS
      lambda_policy:
        region: "{{ sns_region }}"
        profile: "{{ aws_profile_sns }}"
        function_name: "{{ aws_resource_prefix }}_sns2slack"
        statement_id: sns2slack-invoke-from-SNS
        action: lambda:InvokeFunction
        principal: sns.amazonaws.com
        source_arn: arn:aws:sns:us-west-2:{{ aws_account_sns }}:rootmail
      become: false
