---

- meta: flush_handlers

- name: "Install build dependencies for {{ build_data.name }}"
  yum:
    name: "{{ build_data.deps }}"
    state: latest
  when: build_data.deps is defined

- name: "Clone {{ build_data.name }} git repo"
  become: false
  git:
    repo: "{{ build_data.repo }}"
    dest: "~/{{ build_data.name }}"
    version: "{{ build_data.version | default(omit) }}"
    update: true
    force: true

- name: "Build {{ build_data.name }} RPM"
  become: false
  command: fpm -s python -t rpm --python-package-name-prefix python2 setup.py
  register: result
  failed_when:
    - result.rc != 0
    - not (result.stdout | search('File already exists, refusing to continue'))
  changed_when:
    - result.rc == 0
  args:
    chdir: "~/{{ build_data.name }}"

- name: "Copy RPM to local repo"
  become: false
  shell: cp -f ~/{{ build_data.name }}/*.rpm ~/rpmbuild/RPMS
  args:
    warn: false
  notify: Update yum repository

