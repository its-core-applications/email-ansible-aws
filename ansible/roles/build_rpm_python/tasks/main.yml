---

- tags:
    - build
  block:
    - name: Install build dependencies for {{ build_name }}
      yum:
        name: "{{ build_deps }}"
        state: latest
      when: build_deps is defined

    - name: Build {{ build_name }}
      become: false
      block:
        - name: Clone {{ build_name }} git repo
          git:
            repo: "{{ build_repo }}"
            dest: ~/{{ build_name }}
            version: "{{ build_version | default(omit, true) }}"
            update: true
            force: true

        - name: Build {{ build_name }} RPM
          command: fpm -s python -t rpm --python-package-name-prefix python2 setup.py
          register: result
          failed_when:
            - result.rc != 0
            - result.stdout is not search('File already exists, refusing to continue')
          changed_when:
            - result.rc == 0
          args:
            chdir: ~/{{ build_name }}

        - name: Copy RPM to local repo
          shell: cp -f ~/{{ build_name }}/*.rpm ~/rpmbuild/RPMS/x86_64/
          args:
            warn: false

    - import_role:
        name: localrepo_update
