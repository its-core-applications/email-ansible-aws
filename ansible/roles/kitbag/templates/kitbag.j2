#!/bin/bash

name=kitbag
confdir={{ comint_base }}/dispatch

directories=( /home/* )
ftp_base=ftp.box.com/Pyrocumulonimbus/backups
ftp_user=its-collab-pyrocumulonimbus@umich.edu
ftp_passwd=dead60ff

export TMPDIR=/var/tmp
. /usr/libexec/comint/setup

ts=$(date +%F)
retval=0
startts=$(date +%s)
msg=$(
for dir in ${directories[*]} ; do
    free=$(df -k --output=avail $tmpdir | tail -1)
    size=$(du -ks $dir | cut -f1)
    if [[ $size -gt $(( free / 2 )) ]]; then
        echo "$dir is ${size}K, and I'm uncomfortable creating a tarball on a filesystem with only ${free}K free"
        echo "Skipping backup of $dir"
        echo
        continue
    fi
    tarball=$tmpdir/${dir//\//_}.tar.xz
    tar -cJf $tarball $dir 2>/dev/null
    tries=0
    while [[ $(( tries++ )) -lt 5 ]]; do
        curl -s -T $tarball -u $ftp_user:$ftp_passwd --ftp-ssl --ftp-create-dirs "ftp://$ftp_base/$host/$ts/" 2>&1
        curlexit=$?
        [[ $curlexit -eq 0 ]] && break
    done
    if [[ $curlexit -ne 0 ]]; then
        echo "Failed to upload tarball for $dir"
        echo
    fi
    rm -f $tarball 2>&1
done
)

if [[ ! -z "$msg" ]] ; then
    retval=2
fi

if [[ -z "$msg" ]] ; then
    msg="All backups were created and uploaded successfully"
fi

duration=$(( $(date +%s) - startts ))

jq -n -r \
    --arg source $(hostname) \
    --arg status $retval \
    --arg duration $duration \
    --arg msg "$msg" \
    '{ name: "kitbag", source: $source, ttl: 216000, duration: $duration | tonumber, status: $status | tonumber, output: $msg }' | ncat localhost 3030

cleanup
