- tags:
    - spf
    - dns
    - route53
  become: false
  block:
    - name: Create main SPF records
      route53:
        profile: "{{ aws_profile_spfd }}"
        command: create
        overwrite: true
        zone: "{{ spfd }}"
        record: "{{ item.name }}.{{ spfd }}"
        type: TXT
        ttl: 600
        value: "{{ lookup('pipe', role_path ~ '/files/spf-flatten --strict -t -r ' ~ ([item.record] | flatten | join(' ') | quote )) }}"
      loop: "{{ spf_main }}"

    - name: Make sure there are no duplicate names
      assert:
        that: (spf_names | length) == (spf_names | unique | length)
      vars:
        spf_names: "{{ spf_thirdparty | map(attribute='names') | flatten }}"

    - name: Create third-party SPF records
      route53:
        profile: "{{ aws_profile_spfd }}"
        command: create
        overwrite: true
        zone: "{{ spfd }}"
        record: "{{ item.1 }}._ext.{{ spfd }}"
        type: TXT
        ttl: 600
        value: "{{ lookup('pipe', role_path ~ '/files/spf-flatten -t ' ~ ((item.1 == '*') | ternary('-r ', '-u -r ')) ~ ([item.0.record] | flatten | join(' ') | quote)) }}"
      loop: "{{ query('subelements', spf_thirdparty, 'names') }}"
      loop_control:
        label: "{{ item.1 }}"
