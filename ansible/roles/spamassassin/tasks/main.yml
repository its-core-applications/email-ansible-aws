---

- name: Install spamassassin
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - spamassassin
  notify: Restart spamassassin

- name: Configure spamassassin
  copy:
    dest: "/etc/mail/spamassassin/{{ item }}"
    src: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - init.pre
    - v310.pre
    - v312.pre
    - v320.pre
    - v330.pre
    - v340.pre
    - v341.pre
  notify: Restart spamassassin

- name: Local spamassassin config
  template:
    dest: /etc/mail/spamassassin/local.cf
    src: local.cf.j2
    owner: root
    group: root
    mode: 0644
  notify: Restart spamassassin
  tags: mutable

- name: Configure spamd
  copy:
    dest: /etc/sysconfig/spamassassin
    src: spamassassin.sysconfig
    owner: root
    group: root
    mode: 0644
  notify: Restart spamassassin
  tags: configuration

- name: Create /var/spool/simta/.ssh
  file: 
    dest: /var/spool/simta/.ssh
    state: directory
    owner: simta
    group: mail
    mode: 0700
  tags: configuration

- name: Install ssh key for simta
  template:
    dest: /var/spool/simta/.ssh/id_rsa
    src: id_rsa.j2
    owner: simta
    group: mail
    mode: 0400

- name: Disable stock sa-update
  file:
    dest: /etc/cron.d/sa-update
    state: absent

- name: Install sa-update-client
  copy:
    dest: /usr/local/sbin/sa-update-client
    src: sa-update-client
    owner: root
    group: root
    mode: 0755

- name: Configure sa-update-client
  template:
    dest: /usr/local/collaboration/dispatch/sa-update-client.conf
    src: sa-update-client.conf.j2
    owner: root
    group: root
    mode: 0644

- name: Update spamassassin rules
  command: /usr/local/sbin/sa-update-client
  register: result
  failed_when: "result.rc > 1"
  changed_when: "result.rc == 0"
  tags: mutable

- name: Enable spamassassin
  service:
    name: spamassassin
    enabled: yes
  notify: Restart spamassassin

