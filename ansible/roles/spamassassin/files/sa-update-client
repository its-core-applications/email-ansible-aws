#!/bin/bash

EX_OK=0
EX_NOUPDATE=1
EX_ERROR=2

name=sa-update-client
if [[ -d /usr/local/collaboration ]]; then
    confdir=/usr/local/collaboration/dispatch
else
    confdir=/etc/sysconfig/dispatch
fi

update_host=simta@alien.mr.itd.umich.edu
rule_dir=/var/lib/spamassassin/
ssh_key=/var/spool/simta/.ssh/id_rsa
tries=5
sleep=15
retval=$EX_ERROR

. /usr/libexec/comint/setup

while [[ $tries -gt 0 && $retval -eq $EX_ERROR ]]; do
    echo -e "\n\nrsync output:\n" >> $tmpfile
    rsync -rLti \
        -e "ssh -i $ssh_key -o StrictHostKeyChecking=no" \
        --copy-dest=$rule_dir \
        --exclude '/userstate' \
        ${update_host}:$rule_dir ${tmpdir}/sync/ \
        > ${tmpdir}/rsyncout 2>>$tmpfile
    if [[ $? -ne 0 ]]; then
        rm -rf ${tmpdir}/sync/
        (( tries-- ))
    else
        if grep -q '^>' ${tmpdir}/rsyncout ; then
            mv $rule_dir ${tmpdir}/old
            mv ${tmpdir}/sync $rule_dir
            echo -e "\n\nlint output:\n" >> $tmpfile
            spamassassin --lint &>> ${tmpdir}/errout
            if [[ $? -eq 0 ]]; then
                systemctl reload spamassassin > /dev/null
                retval=$EX_OK
            else
                rm -rf $rule_dir
                mv ${tmpdir}/old $rule_dir
                (( tries-- ))
            fi
        else
            retval=$EX_NOUPDATE
        fi
    fi
    if [[ $retval -eq $EX_ERROR ]]; then
        sleep $sleep
    fi
done

if [[ $retval -eq $EX_ERROR ]]; then
    cat $tmpfile | eval $notifycmd_warn $notifywho_warn
fi

cleanup

exit $retval
