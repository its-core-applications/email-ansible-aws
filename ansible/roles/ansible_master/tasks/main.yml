- tags:
    - ansible
    - master
  block:
    - name: Schedule mutable updates
      cron:
        name: ansible-mutable-{{ item }}
        user: "{{ ansible_user }}"
        minute: "*/15"
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/{{ item }}.yml --tags mutable &>/dev/null
      loop:
        - mx
        - egress

    - name: Schedule deprovisioning of spundown hosts
      cron:
        name: ansible-deprovision
        user: "{{ ansible_user }}"
        minute: 13,28,43,58
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/deprovision_spundown.yml &>/dev/null

    - name: Schedule renewal of certificates with LetsEncrypt
      cron:
        name: ansible-letsencrypt
        user: "{{ ansible_user }}"
        minute: 10
        hour: 10
        weekday: 1-5
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/master.yml --tags certificate &>/dev/null

    - name: Schedule cleanup tasks
      cron:
        name: ansible-cleanup-{{ item }}
        user: "{{ ansible_user }}"
        minute: 17
        hour: 17
        weekday: 3
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/cleanup_{{ item }}.yml &>/dev/null
      loop:
        - amis
        - dns
