- tags:
    - ansible
    - master
  block:
    - name: Schedule mutable updates
      cron:
        name: ansible-mutable-{{ item }}
        user: "{{ ansible_user }}"
        minute: "{{ 0 + item_index % 10 }},{{ 15 + item_index % 10 }},{{ 30 + item_index % 10 }},{{ 45 + item_index % 10 }}"
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/{{ item | replace('-', '_') }}.yml --tags mutable &>/dev/null
      loop: "{{ aws_region_classes.common | union(aws_region_classes[aws_status][aws_region]) }}"
      loop_control:
        index_var: item_index

    - name: Schedule cycling of hosts
      cron:
        name: ansible-cycle-{{ item }}
        user: "{{ ansible_user }}"
        minute: "{{ 12 + item_index }}"
        hour: "{{ item_index % 3 }}"
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/replace_{{ item }}.yml &>/dev/null
      loop: "{{ aws_region_group | map('extract', hostvars, 'group_names') | flatten | unique | select('match', 'Class_.+') | difference(singletons) | map('replace', 'Class_', '') | sort }}"
      loop_control:
        index_var: item_index
      vars:
        singletons:
          - Class_ctools_mx
          - Class_jail
          - Class_master
          - Class_syslog

    - name: Schedule spindown of ephemeral tool hosts
      cron:
        name: ansible-shutdown-{{ item }}
        user: "{{ ansible_user }}"
        minute: 0
        hour: 12
        weekday: 6
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/spindown_{{ item }}.yml &>/dev/null
      loop:
        - builder
        - dev

    - name: Schedule deprovisioning of spundown hosts
      cron:
        name: ansible-deprovision
        user: "{{ ansible_user }}"
        minute: 13,28,43,58
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/deprovision_spundown.yml &>/dev/null

    - name: Schedule renewal of certificates with LetsEncrypt
      cron:
        name: ansible-letsencrypt
        user: "{{ ansible_user }}"
        minute: 10
        hour: 10
        weekday: 1-5
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/master.yml --tags certificate &>/dev/null

    - name: Schedule cleanup tasks
      cron:
        name: ansible-cleanup-{{ item }}
        user: "{{ ansible_user }}"
        minute: 17
        hour: 17
        weekday: 3
        job: . ~/ansible-aws/env-setup.sh && ansible-playbook ~/ansible-aws/ansible/cleanup_{{ item }}.yml &>/dev/null
      loop:
        - amis
        - dns
