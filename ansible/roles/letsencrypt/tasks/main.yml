- tags:
    - certificate
    - letsencrypt
  block:
    - name: Create certificate storage directory
      file:
        dest: /etc/pki/collab/private
        owner: root
        group: mail
        mode: "0750"
        state: directory

    - name: Create account key
      command: openssl genrsa -out /etc/pki/collab/private/letsencrypt_account.key 4096
      args:
        creates: /etc/pki/collab/private/letsencrypt_account.key

    - name: Create certificate key
      command: openssl ecparam -genkey -name prime256v1 -out /etc/pki/collab/private/{{ certificate }}.key
      args:
        creates: /etc/pki/collab/private/{{ certificate }}.key
      register: result

    - name: Generate CSR
      command: openssl req -new -sha256 -key /etc/pki/collab/private/{{ certificate }}.key -out /etc/pki/collab/{{ certificate }}.csr -subj /CN={{ certificate }}
      when: result is changed

    - name: Get ACME challenge
      acme_certificate:
        account_email: letsencrypt@devnull.mail.umich.edu
        account_key: /etc/pki/collab/private/letsencrypt_account.key
        acme_directory: https://acme-v02.api.letsencrypt.org/directory
        terms_agreed: true
        acme_version: 2
        challenge: dns-01
        csr: /etc/pki/collab/{{ certificate }}.csr
        fullchain_dest: /etc/pki/collab/private/{{ certificate }}.crt
      register: acme_data

    - name: You challenge me, sirrah?
      delegate_to: localhost
      become: false
      route53:
        profile: "{{ aws_profile_subd }}"
        command: create
        overwrite: true
        wait: true
        zone: "{{ subd }}"
        record: "{{ acme_data.challenge_data[certificate]['dns-01']['resource'] }}.{{ certificate }}"
        type: TXT
        value: "\"{{ acme_data.challenge_data[certificate]['dns-01']['resource_value'] }}\""
        ttl: 30
      when: acme_data is changed

    - name: Get certificate
      acme_certificate:
        account_key: /etc/pki/collab/private/letsencrypt_account.key
        acme_directory: https://acme-v02.api.letsencrypt.org/directory
        terms_agreed: true
        acme_version: 2
        challenge: dns-01
        csr: /etc/pki/collab/{{ certificate }}.csr
        fullchain_dest: /etc/pki/collab/private/{{ certificate }}.crt
        data: "{{ acme_data }}"
