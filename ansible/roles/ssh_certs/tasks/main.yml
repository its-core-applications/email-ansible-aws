- tags:
    - ssh
  block:
    - name: Sign SSH host keys
      shell: cat {{ item }}.pub | vault write -field=signed_key ssh-host-signer/sign/host public_key=- cert_type=host valid_principals={{ inventory_hostname }} > {{ item }}-cert.pub
      args:
        creates: "{{ item }}-cert.pub"
      environment:
        VAULT_ADDR: "{{ lookup('env', 'VAULT_ADDR') }}"
        VAULT_TOKEN: "{{ lookup('file', '~/.vault-token') }}"
      loop: "{{ query('fileglob', '/etc/ssh/ssh_host_*_key') }}"
