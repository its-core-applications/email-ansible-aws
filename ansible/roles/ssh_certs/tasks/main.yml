---

- name: Sign SSH host keys
  shell: "cat {{ item }}.pub | vault write -field=signed_key ssh-host-signer/sign/hostrole public_key=- cert_type=host valid_principals={{ inventory_hostname }} > {{ item }}-cert.pub"
  args:
    creates: "{{ item }}-cert.pub"
  environment:
    VAULT_ADDR: http://127.0.0.1:8200
    VAULT_TOKEN: "{{ lookup('file', '~/.vault-token') }}"
  with_fileglob: /etc/ssh/ssh_host_*_key
