- hosts: localhost
  become: false
  tasks:
    - import_role:
        name: ec2_launch
      vars:
        launch_class: odm
        launch_subnet: "{{ ec2_subnets_public_sorted[aws_region].0 }}"

- hosts: Class_odm:&Status_spinup
  tasks:
    # This is a bit fragile, but it might be sturdy enough
    - name: Attach magic volume
      ec2_vol:
        name: magic_{{ groups.Class_odm.index(inventory_hostname) }}
        region: "{{ region }}"
        profile: "{{ aws_profile_ec2 }}"
        instance: "{{ instance_id }}"
        device_name: xvdd
        volume_type: gp2
        volume_size: 2000
        encrypted: true
        delete_on_termination: false
      delegate_to: localhost
      become: false

    - name: Create magic filesystem
      filesystem:
        dev: /dev/xvdd
        fstype: xfs
        force: false

    - name: Mount magic filesystem
      mount:
        name: /magic
        src: /dev/xvdd
        fstype: xfs
        state: mounted

    - name: Set status to development
      ec2_tag:
        region: "{{ region }}"
        profile: "{{ aws_profile_ec2 }}"
        resource: "{{ instance_id }}"
        tags:
          Status: development
      delegate_to: localhost
      become: false

- hosts: Class_odm
  tasks:
    - name: Fix ownership of /magic
      file:
        path: /magic
        state: directory
        owner: ec2-user
