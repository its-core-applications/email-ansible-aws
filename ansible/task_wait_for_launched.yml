---

- hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Wait for launched instances to be available 
      shell: "for i in {1..60}; do {{ inventory_file }} | grep -q {{ item.id }} && break; sleep 5; done; sleep 5"
      when: item.id is defined
      with_items: "{{ ec2.results | map(attribute='instances') | list }}"

    - name: Flush DNS cache
      command: unbound-control reload
      become: true

    - meta: refresh_inventory
