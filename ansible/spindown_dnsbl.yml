---

- hosts: Class_dnsbl
  gather_facts: false
  serial: 1
  tasks:
    - when: region == aws_region
      block:
        - name: Set status on oldest host to spindown
          delegate_to: localhost
          become: false
          ec2_tag:
            region: "{{ region }}"
            resource: "{{ instance_id }}"
            tags:
              Status: spindown
          when:
            - launch_time == groups.Class_dnsbl | intersect(aws_region_group) | map('extract', hostvars, 'launch_time') | sort | first
            - groups.Class_dnsbl | intersect(groups.Status_spindown | default([])) | length == 0

        - meta: refresh_inventory
          when: groups.Class_dnsbl | intersect(groups.Status_spindown | default([])) | length == 0

- hosts: Class_dnsbl:&Status_spindown
  tasks:
    - when: region == aws_region
      block:
        - import_role:
            name: route53_dns_from_inventory
          vars:
            dns_host: rbldnsd
            dns_group: Class_dnsbl

        - name: Stop sensu
          systemd:
            name: sensu-client
            state: stopped
          ignore_errors: true

        - name: Set status to spundown
          delegate_to: localhost
          become: false
          ec2_tag:
            region: "{{ region }}"
            resource: "{{ instance_id }}"
            tags:
              Status: spundown

