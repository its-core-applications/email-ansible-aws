#!/bin/bash

# packer needs to be run with a specific working directory
cd $(readlink -fn $(dirname "$BASH_SOURCE"))

if [[ $1 ]]; then
    class=$1
else
    class=base
fi

if [[ ! -f ansible/${class}.yml ]]; then
    echo "ansible/${class}.yml doesn't exist, aborting"
    exit 1
fi

# Don't load callbacks like ARA for the ad hoc commands
export ANSIBLE_LOAD_CALLBACK_PLUGINS=0

if [[ $class = 'vdc_relay' ]]; then
    export AWS_PROFILE=$(ansible --playbook-dir ansible localhost -m debug -a 'var=aws_profiles[aws_status]["vdc-core"]' | awk '/aws_profile/{print $NF}' | tr -d '"')
else
    export AWS_PROFILE=$(ansible localhost --playbook-dir ansible -m debug -a 'var=aws_profile' | awk '/aws_profile/{print $NF}' | tr -d '"')
fi

if [[ $2 ]]; then
    os=$2
else
    os=amzn2
fi

echo "Building $class image for $os"

case $os in
    centos7)
        owner='679593333241'
        filter='Name=product-code,Values=aw0evgkw8e5c1q413zgy5pjce'
        root='/dev/sda1'
    ;;
    rhel7)
        owner='309956199498'
        filter='Name=name,Values=RHEL-7.?_HVM_GA*'
        root='/dev/sda1'
    ;;
    *)
        owner='137112412989'
        filter='Name=name,Values=amzn2-ami-hvm-*-x86_64-gp2'
        root='/dev/xvda'
    ;;
esac

if [[ $class = 'base' ]] || [[ $class = 'vdc_relay' ]]; then
    base=$(aws ec2 describe-images --filters "Name=owner-id,Values=$owner" 'Name=state,Values=available' "$filter")
else
    base=$(aws ec2 describe-images --owners self --filters 'Name=state,Values=available' 'Name=tag:image_type,Values=base' "Name=tag:os,Values=$os")
fi

base=$(echo "$base" | jq -r '.Images | sort_by(.CreationDate) | last(.[]).ImageId')

python -c '
import sys, json, yaml
with open(sys.argv[1]) as f:
   print(json.dumps(yaml.safe_load(f), indent=2))
' packer/template.yml >| packer/template.json

# Quick and dirty elision of unnecessary encryption step
if [[ $class != 'base' ]] && [[ $class != 'vdc_relay' ]]; then
    jq 'del(.builders[0].encrypt_boot)' <packer/template.json >packer/munged
    mv -f packer/munged packer/template.json
fi

subnet_id=$(aws ec2 describe-subnets --filters 'Name=tag:Class,Values=public' | jq -r '.Subnets[].SubnetId' | shuf | head -n 1)

packer build -var "aws_region=$AWS_DEFAULT_REGION" -var "image_os=$os" -var "image_type=$class" -var "base_ami=$base" -var "root_device=$root" -var "subnet_id=$subnet_id" packer/template.json
