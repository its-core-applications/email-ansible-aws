variables:
  aws_region: us-west-2
  base_ami: ami-e535c59d
  image_type: base
  image_os: amzn2
  root_device: /dev/xvda
  subnet_id: subnet-xxx

provisioners:
  - type: shell
    script: packer/scripts/ansible.sh

  - type: ansible
    playbook_file: 'ansible/{{ user `image_type` }}.yml'
    ansible_env_vars:
      - ANSIBLE_SSH_PIPELINING=False
# To bootstrap without an existing custom yum repo.
#    extra_arguments: [ '--extra-vars', '{ bootstrap: yes }' ]
    host_alias: '{{ user `image_type` }}'
    groups:
      - Class_{{ user `image_type` }}
      - Status_development

  - type: shell
    script: packer/scripts/cleanup.sh

builders:
  - type: amazon-ebs
    region: '{{ user `aws_region` }}'
    subnet_id: '{{ user `subnet_id` }}'
    instance_type: t2.small
    source_ami: '{{ user `base_ami` }}'
    ami_name: 'ami_{{ user `image_os` }}_{{ user `image_type` }}_{{ timestamp }}'
    launch_block_device_mappings:
      - device_name: '{{ user `root_device` }}'
        volume_type: gp2
        volume_size: 12
        delete_on_termination: true
    encrypt_boot: true
    ena_support: true
    associate_public_ip_address: true
    ssh_keypair_name: '2015-10-16'
    ssh_private_key_file: id_rsa
    ssh_pty: true
    ssh_username: ec2-user
    tags:
      image_type: '{{ user `image_type` }}'
      os: '{{ user `image_os` }}'
    user_data_file: packer/userdata

